name: Qt CMake Build (Windows)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build_windows:
    runs-on: windows-latest

    env:
      QT_VERSION: 6.10.1
      QT_DIR: ${{ github.workspace }}\Qt
      INSTALLER_DIR: ${{ github.workspace }}\installer
      BUILD_DIR: "${{ github.workspace }}\build"
      APP_NAME: "awsmock-qt-ui"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: true

      # -------------------------------
      # Setup C++ compiler
      # -------------------------------
      - name: Setup MSVC Environment
        uses: ilammy/msvc-dev-cmd@v1

      # -------------------------------
      # Install Python + aqtinstall
      # -------------------------------
      - name: Install Python + aqtinstall
        run: |
          python -m pip install --upgrade pip
          pip install aqtinstall

      # -------------------------------
      # Install Qt 6.10.1 + modules
      # -------------------------------
      - name: Install Qt 6.10.1 + modules
        run: |
          python -m aqt install-qt windows desktop $env:QT_VERSION win64_msvc2022_64 --outputdir $env:QT_DIR
          python -m aqt install-qt windows desktop $env:QT_VERSION win64_msvc2022_64 --outputdir $env:QT_DIR --modules qtcharts qtimageformats

      # -------------------------------
      # Configure & Build
      # -------------------------------
      - name: Configure and Build Application
        shell: powershell
        run: |
          cmake -B build -S . -G Ninja -DCMAKE_BUILD_TYPE=Release -DQt6_DIR="$env:QT_DIR\$env:QT_VERSION\msvc2022_64\lib\cmake\Qt6"
          $cores = [Environment]::ProcessorCount
          cmake --build build --config Release --parallel $cores

      # -------------------------------
      # Deploy Qt binaries
      # -------------------------------
      - name: Deploy Qt runtime
        shell: powershell
        run: |
          $exePath = "$env:BUILD_DIR\Release\awsmock-qt-ui.exe"
          $deployDir = "$env:INSTALLER_DIR\packages\de.jensvogt.awsmockqtui\data"
          New-Item -ItemType Directory -Path $deployDir -Force
          & "$env:QT_DIR\$env:QT_VERSION\msvc2022_64\bin\windeployqt6.exe" $exePath --dir $deployDir
          Copy-Item $exePath $deployDir

      # -------------------------------
      # Build Qt Installer
      # -------------------------------
      - name: Build Qt Installer
        run: |
          # Assuming you have installer/config/config.xml & packages/com.jensvogt.awsmockqtui/
          binarycreator -c "$env:INSTALLER_DIR\config\config.xml" -p "$env:INSTALLER_DIR\packages" "$env:INSTALLER_DIR\AwsmockQtUiInstaller.exe"

      # -------------------------------
      # Upload the installer
      # -------------------------------
      - name: Upload installer
        uses: actions/upload-artifact@v4
        with:
          name: QtInstaller-Windows
          path: installer/AwsmockQtUiInstaller.exe
          retention-days: 90

      # -------------------------------
      # Create release
      # -------------------------------
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')  # Only run on tags
        uses: softprops/action-gh-release@v2
        with:
          files: $env:APP_NAME-windows-x64.exe
          name: Release ${{ github.ref_name }}
          body: |
            **New release: ${{ github.ref_name }}**           
            This release includes bug fixes and new features.
          draft: false
          prerelease: false