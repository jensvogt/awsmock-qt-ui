name: Build Qt Project (Ubuntu)

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - uses: actions/checkout@v4

      # 2. Install system dependencies
      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3 python3-pip python3-venv ninja-build \
            libgl1-mesa-dev libx11-dev libxext-dev libxrender-dev \
            libfontconfig1-dev libfreetype6-dev

      # 3. Install aqtinstall safely using pipx
      - name: Install aqtinstall via pipx
        run: |
          python3 -m pip install --user pipx
          python3 -m pipx ensurepath
          ~/.local/bin/pipx install aqtinstall

      # 4. Install Qt 6.10.1 modules required for your project
      - name: Install Qt 6.10.1
        run: |
          export PATH=$HOME/.local/bin:$PATH
          aqt install-qt linux desktop 6.10.1 gcc_64 \
            -m qtbase qtwidgets qtsvg qtcharts qttools qtimageformats

      # 5. Add Qt to PATH
      - name: Add Qt to PATH
        run: echo "$HOME/Qt/6.10.1/gcc_64/bin" >> $GITHUB_PATH

      # 6. Configure CMake with correct CMAKE_PREFIX_PATH
      - name: Configure CMake
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="$HOME/Qt/6.10.1/gcc_64" \
            -G Ninja

      # 7. Build the project
      - name: Build
        run: cmake --build build --config Release

      # Optional: package build (ZIP)
      - name: Package
        run: |
          cd build
          cpack -G ZIP || true

      # Upload build artifacts
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: qt-build-linux
          path: build/*