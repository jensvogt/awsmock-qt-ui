name: Build Qt Project (Ubuntu)

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      QT_VERSION: "6.10.1"
      QT_ARCH: "gcc_64"
      QT_MODULES: "all"
      QT_ROOT: "$HOME/Qt/$QT_VERSION/$QT_ARCH"

    steps:
      # 1. Checkout repository
      - uses: actions/checkout@v4

      # 2. Install system dependencies
      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3 python3-pip python3-venv ninja-build \
            libgl1-mesa-dev libx11-dev libxext-dev libxrender-dev \
            libfontconfig1-dev libfreetype6-dev

      # 3. Install pipx safely
      - name: Install pipx
        run: |
          python3 -m pip install --user pipx
          export PATH="$HOME/.local/bin:$PATH"
          python3 -m pipx ensurepath

      # 4. Install aqtinstall via pipx
      - name: Install aqtinstall
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          python3 -m pipx install aqtinstall

      # 5. Restore Qt cache if available
      - name: Restore Qt cache
        uses: actions/cache@v3
        with:
          path: $HOME/Qt
          key: qt-${{ runner.os }}-${{ env.QT_VERSION }}-${{ env.QT_ARCH }}

      # 6. Install Qt using aqt if not cached
      - name: Install Qt 6.10.1
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          if [ ! -d "$QT_ROOT" ]; then
            aqt install-qt linux desktop $QT_VERSION $QT_ARCH -m $QT_MODULES
          fi
          echo "$QT_ROOT"
          ls -l "$QT_ROOT"

      # 7. Configure CMake with Qt
      - name: Configure CMake
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="$QT_ROOT" \
            -G Ninja

      # 8. Build project
      - name: Build
        run: cmake --build build --config Release

      # Optional: package build (ZIP)
      - name: Package
        run: |
          cd build
          cpack -G ZIP || true

      # Upload build artifacts
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: qt-build-linux
          path: build/*